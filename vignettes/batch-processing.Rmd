---
title: "Batch Processing Guide"
author: "uncoverappLib"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Batch Processing Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

# Overview

uncoverappLib can be used in **two ways**:

1. **Interactive Mode** (Shiny App) - Real-time exploration and visualization
2. **Batch Mode** (Command-line) - Automated pipelines and reproducible analysis

This guide covers **Batch Mode** for processing multiple samples programmatically.

---

# Workflow

```
Gene List + Coverage Files (BAM/BED)
         ‚Üì
   buildInput()
         ‚Üì
    Coverage BED + Statistics
         ‚Üì
 annotate_all_lowcov()
         ‚Üì
   Annotated Excel Files
```

---

# Quick Start

## Step 1: Prepare Input Files

**genes.txt:**
```
BRCA1
BRCA2
TP53
PTEN
```

**samples.list:**
```
/path/to/patient_001.bam
/path/to/patient_002.bam
/path/to/patient_003.bam
```

## Step 2: Generate Coverage

```{r coverage}
library(uncoverappLib)

buildInput(
  geneList = "genes.txt",
  sampleList = "samples.list",        # ‚Üê Updated parameter name
  genome = "hg38",
  chromosome_notation = "chr",        # ‚Üê Updated parameter name
  type_input = "genes",
  type_coverage = "bam",
  MAPQ.min = 20,
  base.quality = 20,
  outDir = "./output"
)

# Output files:
# - ./output/output/DATE.bed (coverage data)
# - ./output/output/DATE_statistical_summary.txt
```

## Step 3: Annotate Low Coverage Positions

```{r annotate}
# Get the coverage file
coverage_file <- list.files(
  "./output/output", 
  pattern = "\\.bed$", 
  full.names = TRUE
)[1]

# Annotate for first sample
annotate_all_lowcov(
  sample_data = coverage_file,
  target_sample = "count_patient_001",    # ‚Üê Note: "count_" prefix
  coverage_threshold = 20,
  genome = "hg38",
  output_formatted = "patient_001_annotated.xlsx"
)
```

---

# Detailed Examples

## Example 1: Single Sample Analysis

Process one BAM file for a clinical gene panel:

```{r example1}
# Create input files
cat("BRCA1\nBRCA2\nTP53\nATM\nCHEK2\n", file = "breast_cancer_panel.txt")
cat("/data/patient001.bam\n", file = "patient001.list")

# Step 1: Generate coverage
buildInput(
  geneList = "breast_cancer_panel.txt",
  sampleList = "patient001.list",
  genome = "hg38",
  chromosome_notation = "chr",
  type_input = "genes",
  type_coverage = "bam",
  MAPQ.min = 30,                    # Stringent for clinical
  base.quality = 20,
  outDir = "./patient001_results"
)

# Step 2: Find coverage file
coverage_file <- list.files(
  "./patient001_results/output", 
  pattern = "\\.bed$", 
  full.names = TRUE
)[1]

# Step 3: Annotate low-coverage positions
annotate_all_lowcov(
  sample_data = coverage_file,
  target_sample = "count_patient001",   # Column name in BED file
  coverage_threshold = 20,
  genome = "hg38",
  output_intersect = "patient001_lowcov.tsv",
  output_formatted = "patient001_lowcov.xlsx"
)
```

**Output:**
- `patient001_lowcov.tsv`: Tab-separated data
- `patient001_lowcov.xlsx`: Formatted Excel with conditional coloring

---

## Example 2: Cohort Analysis

Process multiple samples efficiently:

```{r example2}
# Define cohort
samples <- c("patient001", "patient002", "patient003", "patient004")

# Create BAM list
bam_files <- paste0("/data/wes/", samples, ".bam")
writeLines(bam_files, "cohort.list")

# Step 1: Generate coverage for all samples (one command!)
buildInput(
  geneList = "breast_cancer_panel.txt",
  sampleList = "cohort.list",
  genome = "hg38",
  chromosome_notation = "chr",
  type_input = "genes",
  type_coverage = "bam",
  MAPQ.min = 30,
  base.quality = 20,
  outDir = "./cohort_results"
)

# Step 2: Get coverage file (contains all samples)
coverage_file <- list.files(
  "./cohort_results/output", 
  pattern = "\\.bed$", 
  full.names = TRUE
)[1]

# Step 3: Annotate each sample separately
for (sample in samples) {
  cat("Processing", sample, "...\n")
  
  annotate_all_lowcov(
    sample_data = coverage_file,
    target_sample = paste0("count_", sample),  # ‚Üê Add "count_" prefix
    coverage_threshold = 20,
    genome = "hg38",
    output_formatted = paste0("./results/", sample, "_annotated.xlsx")
  )
}

cat("Cohort processing complete!\n")
```

---

## Example 3: Using BED Coverage Files (Much Faster!)

If you already have coverage computed, use BED files:

```{r example3}
# Generate BED coverage files with bedtools (run in bash)
# for bam in *.bam; do
#   bedtools genomecov -ibam $bam -bg > ${bam%.bam}_coverage.bed
# done

# Create list of BED coverage files
bed_files <- list.files("/data/coverage", pattern = "_coverage.bed$", full.names = TRUE)
writeLines(bed_files, "coverage.list")

# Process with BED files (10-50x faster than BAM!)
buildInput(
  geneList = "genes.txt",
  sampleList = "coverage.list",
  genome = "hg38",
  chromosome_notation = "chr",
  type_input = "genes",
  type_coverage = "bed",              # ‚Üê BED instead of BAM
  input_coord_system = "0-based",     # ‚Üê Specify coordinate system!
  outDir = "./output"
)
```

**BED coverage format:**
```
chr1    100    101    25
chr1    101    102    30
chr1    102    103    18
```
*Columns: chromosome, start, end, coverage_depth*

**When to use BED:**
- ‚úÖ Already have coverage computed
- ‚úÖ Need faster processing
- ‚úÖ Re-analyzing with different gene lists
- ‚úÖ Working with large cohorts

---

## Example 4: Target BED Instead of Gene List

Use genomic coordinates directly:

```{r example4}
# Create target BED file
target_bed <- data.frame(
  chr = c("chr17", "chr13", "chr17"),
  start = c(41196312, 32889617, 7571720),
  end = c(41277500, 32973809, 7590868),
  name = c("BRCA1", "BRCA2", "TP53")
)
write.table(target_bed, "targets.bed", 
            quote = FALSE, row.names = FALSE, col.names = FALSE, sep = "\t")

# Process with target BED
buildInput(
  geneList = "targets.bed",
  sampleList = "samples.list",
  genome = "hg38",
  chromosome_notation = "chr",
  type_input = "target",              # ‚Üê Use target BED
  type_coverage = "bam",
  MAPQ.min = 20,
  base.quality = 20,
  outDir = "./output"
)
```

---

# Input File Formats

## Gene List (`genes.txt`)
HGNC official gene symbols, one per line:
```
BRCA1
TP53
POLG
ATM
CHEK2
```

## Target BED (`targets.bed`)
Genomic regions (tab-separated, no header):
```
chr17   41196312    41277500    BRCA1
chr17   7571720     7590868     TP53
chr11   108093211   108239829   ATM
```
*Columns: chromosome, start, end, gene/amplicon_name*

## Sample List (`samples.list`)
Absolute paths to BAM or BED files, one per line:
```
/data/cohort/patient_001.bam
/data/cohort/patient_002.bam
/data/cohort/patient_003.bam
```

## BED Coverage Format (if using pre-computed)
Tab-separated, no header:
```
chr1    100    101    25
chr1    101    102    30
chr1    102    103    18
```
*Columns: chromosome, start, end, coverage_depth*

**Coordinate systems:**
- `0-based`: Standard BED (bedtools, mosdepth)
- `1-based`: SAM/VCF format (samtools depth)

---

# Output Files

## 1. Coverage BED File

**Location:** `output/output/DATE.bed`

**Format:**
```
chromosome  start      end        count_patient_001  count_patient_002
chr17       41196312   41196312   45                 38
chr17       41196313   41196313   48                 42
chr17       41196314   41196314   52                 45
```

**Features:**
- 1-based coordinates (regardless of input)
- Column naming: `count_FILENAME`
- One row per genomic position
- Ready for app loading

---

## 2. Statistical Summary

**Location:** `output/output/DATE_statistical_summary.txt`

**Format:**
```
SYMBOL  sample              Total_bases  Mean_coverage  Median_coverage  percentage_bases_under_20x
BRCA1   sample_patient_001  80000        45.3           42               5.2
BRCA2   sample_patient_001  84000        38.7           35               8.1
TP53    sample_patient_001  20000        52.1           50               2.3
```

**Metrics:**
- `Total_bases`: Total target bases for gene
- `Mean_coverage`: Weighted mean (accounts for interval lengths)
- `Median_coverage`: Median across all positions
- `number_of_intervals_under_20x`: Count of low-coverage intervals
- `bases_under_20x`: Total bases below threshold
- `percentage_bases_under_20x`: Percentage below threshold

---

## 3. Annotated Variants (from annotate_all_lowcov)

**Format:** Excel with conditional formatting

**Columns include:**
- Genomic position (chr, start, end)
- Coverage depth
- Variant information (REF, ALT, rsID)
- Gene name
- Prediction scores (SIFT, Polyphen2, CADD, M-CAP, MutationAssessor)
- Population frequencies (gnomAD)
- Clinical annotations (ClinVar, OMIM)
- HGVS nomenclature

**Color coding:**
- üî¥ Red: Pathogenic predictions, ClinVar entries, high-impact variants
- üü¢ Green: Benign predictions, common variants
- üü° Yellow: Highlighted important variants

---

# Advanced Usage

## Parallel Processing

Process samples in parallel for speed:

```{r parallel}
library(parallel)

# Annotate multiple samples in parallel
mclapply(samples, function(s) {
  annotate_all_lowcov(
    sample_data = coverage_file,
    target_sample = paste0("count_", s),
    coverage_threshold = 20,
    genome = "hg38",
    output_formatted = paste0(s, "_annotated.xlsx")
  )
}, mc.cores = 4)
```

---

## Custom Annotation Database

Use local annotation files:

```{r custom_ann}
# Point to custom dbNSFP file
annotate_all_lowcov(
  sample_data = "coverage.bed",
  target_sample = "count_sample1",
  coverage_threshold = 20,
  genome = "hg38",
  annotation_file = "/custom/path/sorted_hg38.bed.gz"
)
```

---

## Adding OMIM/Clinical Annotations

Merge gene-level phenotype data:

```{r omim}
# Create OMIM annotation file (tab-separated)
omim_data <- data.frame(
  SYMBOL = c("BRCA1", "BRCA2", "TP53"),
  Disease = c("Breast cancer", "Breast cancer", "Li-Fraumeni syndrome"),
  Inheritance = c("AD", "AD", "AD"),
  OMIM_ID = c("113705", "600185", "191170")
)
write.table(omim_data, "omim_annotations.txt", 
            quote = FALSE, row.names = FALSE, sep = "\t")

# Add during buildInput
buildInput(
  geneList = "genes.txt",
  sampleList = "samples.list",
  genome = "hg38",
  chromosome_notation = "chr",
  type_input = "genes",
  type_coverage = "bam",
  outDir = "./output",
  annotation_file = "omim_annotations.txt"  # ‚Üê Merged with statistics
)
```

**Result:** Statistical summary includes disease/inheritance columns.

---

## Automated Pipeline Example

Complete pipeline with error handling:

```{r pipeline}
process_clinical_panel <- function(patient_id, bam_file, gene_panel) {
  
  cat("Processing patient:", patient_id, "\n")
  
  # Step 1: Coverage
  tryCatch({
    writeLines(bam_file, paste0(patient_id, ".list"))
    
    buildInput(
      geneList = gene_panel,
      sampleList = paste0(patient_id, ".list"),
      genome = "hg38",
      chromosome_notation = "chr",
      type_input = "genes",
      type_coverage = "bam",
      MAPQ.min = 30,
      base.quality = 20,
      outDir = paste0("./results/", patient_id)
    )
    
    cat("  ‚úì Coverage computed\n")
  }, error = function(e) {
    cat("  ‚úó Coverage failed:", e$message, "\n")
    return(NULL)
  })
  
  # Step 2: Annotation
  coverage_file <- list.files(
    paste0("./results/", patient_id, "/output"),
    pattern = "\\.bed$",
    full.names = TRUE
  )[1]
  
  if (!is.null(coverage_file)) {
    tryCatch({
      annotate_all_lowcov(
        sample_data = coverage_file,
        target_sample = paste0("count_", patient_id),
        coverage_threshold = 20,
        genome = "hg38",
        output_formatted = paste0("./results/", patient_id, "_annotated.xlsx")
      )
      
      cat("  ‚úì Annotation complete\n")
    }, error = function(e) {
      cat("  ‚úó Annotation failed:", e$message, "\n")
    })
  }
  
  cat("  Done!\n\n")
}

# Run pipeline
patients <- data.frame(
  id = c("P001", "P002", "P003"),
  bam = c("/data/P001.bam", "/data/P002.bam", "/data/P003.bam")
)

for (i in 1:nrow(patients)) {
  process_clinical_panel(
    patient_id = patients$id[i],
    bam_file = patients$bam[i],
    gene_panel = "breast_cancer_panel.txt"
  )
}
```

---

# Performance Tips

1. **Use BED coverage files** instead of BAM (10-50x faster)
2. **Pre-filter gene lists** to only genes of interest
3. **Increase quality filters** (MAPQ ‚â• 30) to reduce positions processed
4. **Process samples in parallel** with `mclapply()`
5. **Use target BED** instead of gene list for custom regions
6. **Cache annotation files** locally (run `setup_uncoverapp()` once)

**Example timing (100 genes, 1 sample):**
- BAM processing: 5-15 minutes
- BED processing: 30 seconds - 2 minutes
- Annotation: 10-30 seconds

---

# Troubleshooting

## "No valid genes found"
**Solution:**
- Check gene names are **HGNC official symbols** (e.g., `TP53` not `p53`)
- Verify correct genome assembly (hg19 vs hg38)
- Check log file: `output/output/preprocessing_log.txt`

## "Target sample not found in coverage file"
**Solution:**
- Check column names in BED file: `head -n 1 coverage.bed`
- Use correct prefix: `count_patient001` (with `count_`)
- Sample names derived from input filenames

## "Cannot read BAM file"
**Solution:**
- Ensure BAM files are **indexed** (`.bai` files present)
- Verify absolute paths in `.list` file
- Check file permissions: `ls -l file.bam`
- Test BAM: `samtools view file.bam | head`

## "No annotation files found"
**Solution:**
```{r download_ann}
# Download annotation databases (run once)
library(uncoverappLib)
setup_uncoverapp()
check_annotations()
```

## "Processing too slow"
**Solution:**
- Switch to BED coverage files
- Increase `MAPQ.min` and `base.quality`
- Process in smaller batches
- Use parallel processing

---

# Best Practices

1. **Organize by project:**
   ```
   project/
   ‚îú‚îÄ‚îÄ input/
   ‚îÇ   ‚îú‚îÄ‚îÄ genes.txt
   ‚îÇ   ‚îî‚îÄ‚îÄ samples.list
   ‚îú‚îÄ‚îÄ output/
   ‚îÇ   ‚îî‚îÄ‚îÄ coverage.bed
   ‚îî‚îÄ‚îÄ results/
       ‚îú‚îÄ‚îÄ patient_001_annotated.xlsx
       ‚îî‚îÄ‚îÄ patient_002_annotated.xlsx
   ```

2. **Keep logs:**
   - Save preprocessing logs
   - Document gene lists used
   - Track failed samples

3. **Quality control:**
   - Review statistical summaries
   - Check genes_without_coverage.txt
   - Verify chromosome naming consistency

4. **Reproducibility:**
   - Use exact HGNC gene symbols
   - Document genome build
   - Save complete sample lists
   - Version control analysis scripts

---

# See Also

- **Interactive Mode:** `vignette("interactive-mode")`
- **Function Reference:** `?buildInput`, `?annotate_all_lowcov`
- **Installation:** `vignette("installation")`
- **GitHub:** https://github.com/annaballestrazzi/uncoverappLib

---

# Session Info

```{r sessioninfo, eval=TRUE}
sessionInfo()
```
